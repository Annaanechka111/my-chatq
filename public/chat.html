<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Chat</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body class="chat-page">
    <video id="bgVideo" autoplay loop muted playsinline>
      <source src="leopard.mp4" type="video/mp4">
    </video>
    <div class="chat-container">
      <header class="chat-header">
        <div class="title">Chat</div>
        <div id="userInfo" class="user-info"></div>
      </header>

      <div id="messages" class="messages" aria-live="polite"></div>

      <div class="input-area">
        <input id="msg" placeholder="Напишите сообщение..." maxlength="500" />
        <button id="sendBtn" title="Отправить">➤</button>
      </div>
    </div>

    <script>
      const nick = localStorage.getItem("nickname");
      if (!nick) {
        window.location.href = "/";
      }

      document.getElementById("userInfo").textContent = "Вы: " + nick;

      const protocol = location.protocol === "https:" ? "wss" : "ws";
      const socket = new WebSocket(protocol + "://" + location.host);

      const messagesEl = document.getElementById("messages");
      const inputEl = document.getElementById("msg");
      const sendBtn = document.getElementById("sendBtn");

      function appendMessage(sender, text, isMe) {
        const el = document.createElement("div");
        el.className = "msg " + (isMe ? "me" : "other");

        const name = document.createElement("div");
        name.className = "msg-name";
        name.textContent = sender;

        const body = document.createElement("div");
        body.className = "msg-body";
        body.textContent = text;

        el.appendChild(name);
        el.appendChild(body);
        messagesEl.appendChild(el);

        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      socket.addEventListener("open", () => {
        console.log("Connected to server");
      });

      socket.addEventListener("message", (ev) => {
        let data;
        try {
          data = JSON.parse(ev.data);
        } catch (e) {
          return;
        }

        // История от сервера
        if (data.type === "history") {
          data.messages.forEach((m) => {
            appendMessage(m.sender, m.msg, m.sender === nick);
          });
          return;
        }

        // Новое сообщение
        if (data.type === "message") {
          appendMessage(
            data.message.sender,
            data.message.msg,
            data.message.sender === nick
          );
        }
      });

      socket.addEventListener("close", () => {
        const notice = document.createElement("div");
        notice.className = "notice";
        notice.textContent = "Отключено от сервера.";
        messagesEl.appendChild(notice);
      });

      function sendMsg() {
        const text = inputEl.value.trim();
        if (!text) return;
        const payload = nick + "::" + text;
        socket.send(payload);
        inputEl.value = "";
      }

      sendBtn.addEventListener("click", sendMsg);
      inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendMsg();
      });

      // Первое сообщение (системное)
      appendMessage(
        "Система",
        "Пишите сообщение и нажимайте Enter или кнопку.",
        false
      );
    </script>
  </body>
</html>
